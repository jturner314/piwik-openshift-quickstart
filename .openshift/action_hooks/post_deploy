#!/bin/bash
# This is a simple post deploy hook executed after your application
# is deployed and started.  This script gets executed directly, so
# it could be python, php, ruby, etc.

# Copy the Database config with openshift database variables over the existing installed default config file
cp -rf ${OPENSHIFT_REPO_DIR}/.openshift/action_hooks/config/FormDatabaseSetup.php ${OPENSHIFT_REPO_DIR}/php/plugins/Installation/FormDatabaseSetup.php

# Copy the SuperAdmin config over the existing installed default config file
cp -rf ${OPENSHIFT_REPO_DIR}/.openshift/action_hooks/config/FormSuperUser.php ${OPENSHIFT_REPO_DIR}/php/plugins/Installation/FormSuperUser.php

# Fix file integrity of the installation by updating the php/config/manifest.inc.php with the new file lengths and md5sum hash values (This allows the above files in this script to be copied over the default installation).
find $OPENSHIFT_REPO_DIR/php/ -type f -printf '%s ' -exec md5sum {} \; | grep -v "user/.htaccess" | egrep -v 'manifest.inc.php|autoload.php|autoload_real.php' | sed '1,$ s/\([0-9]*\) \([a-z0-9]*\) *.*\/php\/\(.*\)/\t\t"\3" => array("\1", "\2"),/;' | sort | sed '1 s/^/<?php\n\/\/ This file is automatically generated during the Piwik build process\nnamespace Piwik;\nclass Manifest {\n\tstatic $files=array(\n/; $ s/$/\n\t);\n}/' > $OPENSHIFT_REPO_DIR/php/config/manifest.inc.php